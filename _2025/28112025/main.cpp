#include "common.h"
#include <iostream>
#include <vector>
using namespace std;

u128 modpow(u128 a, u128 b, u128 m);

std::ostream &operator<<(std::ostream &dest, u128 value)
{
    std::ostream::sentry s(dest);
    if (s)
    {
        __uint128_t tmp = value;
        char buffer[128];
        char *d = std::end(buffer);
        do
        {
            --d;
            *d = "0123456789"[tmp % 10];
            tmp /= 10;
        } while (tmp != 0);
        int len = std::end(buffer) - d;
        if (dest.rdbuf()->sputn(d, len) != len)
        {
            dest.setstate(std::ios_base::badbit);
        }
    }
    return dest;
}

int main()
{
    vector<tuple<u128, u128, u128>> tests = {
        {994266, 64128044844, 6334837},
        {41803, 75711132218, 6778741},
        {142081, 21314956899, 1970219},
        {486593, 30822004266, 6623581},
        {225272, 88319488293, 1837489},
        {682956, 99897153840, 1837489},
        {592653, 59102008592, 1837489},
        {155830, 49434919779, 1837489},
        {838099, 28233603445, 6334837},
        {872394, 57049572474, 6605969},
        {333031, 19789316284, 6334837},
        {716380, 61567156014, 3030107},
        {305092, 92605843623, 8053541},
        {352663, 11014868747, 3849151},
        {827684, 77706032728, 9992009},
        {290355, 89566847644, 1970219},
        {789734, 96837538538, 1289627},
        {432408, 53923757281, 6778741},
        {931957, 75714870385, 6334837},
        {814573, 56993085815, 6778741},
        {663940, 33908656403, 1289627},
        {687521, 48102243749, 9992009},
        {68955, 15760361215, 1970219},
        {967119, 77693059406, 6334837},
        {608375, 77451738037, 6334837},
        {358465, 20378298946, 6605969},
        {572903, 95251987561, 6605969},
        {400610, 35781883917, 6334837},
        {249718, 99673964749, 5548519},
        {764940, 29461461657, 8053541},
        {350972, 88340306869, 5548519},
        {729103, 22444887653, 3849151},
        {617867, 65688208004, 6334837},
        {807731, 91353799673, 3030107},
        {714202, 78692297514, 1970219},
        {629591, 80404994107, 1289627},
        {475500, 64425994050, 8053541},
        {229501, 66041597209, 9992009},
        {105907, 36609705520, 8053541},
        {216117, 74017175825, 1970219},
        {284849, 24561017406, 1289627},
        {969923, 83611810687, 1970219},
        {672537, 88327966698, 5548519},
        {469026, 31416262019, 3849151},
        {853204, 78673177120, 6778741},
        {683461, 30831676220, 5548519},
        {600599, 10712293320, 3030107},
        {909502, 35500016325, 6778741},
        {826389, 40010544613, 6605969},
        {701250, 34790747648, 1970219},
        {456662, 28556388092, 3849151},
        {572994, 77414211002, 6334837},
        {479007, 30094212311, 6605969},
        {336866, 98779321845, 1289627},
        {849385, 70659555740, 1970219},
        {171010, 69525350412, 8053541},
        {303202, 16342187755, 5548519},
        {454144, 20769619602, 1289627},
        {580259, 69370899933, 6778741},
        {951569, 97687128325, 6334837},
        {298677, 16820671149, 6778741},
        {379917, 98688742658, 8053541},
        {347765, 48018680723, 1837489},
        {962248, 36555748976, 6334837},
        {356317, 42453671351, 6605969},
        {354868, 14828959361, 6334837},
        {160394, 42548420595, 9992009},
        {669915, 39010297032, 6778741},
        {655876, 94990625221, 6334837},
        {481618, 92739876978, 6605969},
        {823661, 50768061477, 6334837},
        {814452, 38685369467, 1837489},
        {170167, 85569810152, 9992009},
        {922887, 14665337009, 1837489},
        {387911, 74128654809, 3030107},
        {880414, 93049748776, 3030107},
        {611676, 63149116322, 1970219},
        {697710, 51422243180, 3849151},
        {339125, 85393804057, 8053541},
        {131399, 72799699970, 1289627},
        {273568, 72359301290, 6623581},
        {75879, 82957492382, 6334837},
        {253243, 47896902625, 6334837},
        {541329, 77265550791, 1837489},
        {33336, 25609501760, 6778741},
        {834769, 87445762066, 3849151},
        {802007, 27556042796, 3849151},
        {329718, 57437727804, 1289627},
        {275797, 55927827049, 6605969},
        {296319, 54218819218, 3849151},
        {742626, 96847900220, 5548519},
        {439230, 68473855230, 1289627},
        {207214, 35207349666, 6778741},
        {565134, 92799942007, 6778741},
        {709893, 85405213029, 9992009},
        {869656, 34920514914, 9992009},
        {86252, 24348781752, 6778741},
        {522958, 84686109937, 3849151},
        {106476, 42493718401, 5548519},
        {36890, 12933971576, 9992009},
    };

    for (auto t : tests)
    {
        u128 a = g0(t), b = g1(t), m = g2(t);
        cout << a << '^' << b << " = " << modpow(a, b, m) << " (mod " << m << ")" << endl;
    }

    return 0;
}
